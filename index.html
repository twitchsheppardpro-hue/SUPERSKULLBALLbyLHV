<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Skullball – V2</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg-dark:#0C131B;
  --panel:#111823;
  --ink:#EAF0FB;
  --muted:#9CA9BB;
  --accent:#F59E0B; /* orange active pill */
  --pill:#1B2432;
  --pill-border:#2A3647;
  --pill-hover:#222E40;
  --gold1:#D3AD6B;
  --gold2:#B18753;
  --row-sep:#1E2A3A;
  --ok:#22C55E;
  --danger:#EF4444;
}

/* Base */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  color:var(--ink);
  background:linear-gradient(135deg,#002654 0%,#002654 30%,#ffffff 50%,#CE1126 80%,#CE1126 100%);
  background-attachment:fixed;
}
.container{max-width:1280px;margin:0 auto;padding:0 16px}

/* Header */
header.head{
  position:sticky;top:0;z-index:100;
  padding:18px 0;
  border-bottom:1px solid rgba(255,255,255,.08);
  background:linear-gradient(90deg,rgba(0,38,84,.92) 0%,rgba(0,38,84,.75) 40%,rgba(255,255,255,.14) 60%,rgba(206,17,38,.36) 78%,rgba(206,17,38,.62) 100%);
  backdrop-filter:blur(8px);
}
.head-grid{display:grid;grid-template-columns:auto 1fr auto;gap:20px;align-items:center}
.event{display:flex;align-items:center;gap:16px}
.event-logo{
  width:96px;height:96px;border-radius:14px;object-fit:cover;
  background:#0b121c;border:1px solid rgba(255,255,255,.12);
  box-shadow:0 12px 28px rgba(0,0,0,.35);
}
h1.title{margin:0;font-weight:800;font-size:28px;letter-spacing:.2px;text-shadow:0 2px 8px rgba(0,0,0,.35)}

.nav{display:flex;gap:14px;flex-wrap:wrap}
.pill{
  height:44px;display:inline-flex;align-items:center;gap:10px;
  padding:0 18px;border-radius:16px;
  background:var(--pill);
  border:1px solid var(--pill-border);
  color:var(--ink);font-weight:700;cursor:pointer;user-select:none;
  transition:transform .06s ease, background .15s ease, color .15s ease, border-color .15s ease;
}
.pill:hover{background:var(--pill-hover);transform:translateY(-1px)}
.pill.active{background:var(--accent);color:#2A1800;border-color:transparent}
.admin{justify-self:end}

/* Main */
main{padding:22px 0 64px}
.panel{
  background:linear-gradient(180deg,rgba(10,14,20,.92),rgba(10,14,20,.92)) padding-box;
  border:1px solid rgba(255,255,255,.10);
  border-radius:18px;padding:18px;box-shadow:0 10px 32px rgba(0,0,0,.35)
}
.caption{color:var(--muted);font-size:14px;margin-bottom:10px}

/* Subnav like badges */
.subnav{display:flex;gap:8px;margin-bottom:12px}
.subnav .pill{height:36px;padding:0 14px;border-radius:999px;background:#0F1723;border-color:#233046}
.subnav .pill.active{background:var(--accent);color:#2A1800}

/* Standings table */
.table{width:100%;border-collapse:collapse}
.table thead th{
  font-size:14px;text-align:left;padding:12px 10px;color:#DDE8F8;border-bottom:1px solid rgba(255,255,255,.08)
}
.table tbody td{padding:16px 10px;border-bottom:1px solid rgba(255,255,255,.06);font-size:15px}
.table .pos{width:40px;font-weight:800;color:#fff}
.team{display:flex;align-items:center;gap:12px}
.logo{width:48px;height:48px;border-radius:12px;object-fit:cover;background:#0a0f16;border:1px solid rgba(255,255,255,.14)}
.row-top{background:linear-gradient(0deg,rgba(0,0,0,.12),rgba(0,0,0,.12)), linear-gradient(90deg,var(--gold1),var(--gold2))}
.row-regular{background:rgba(255,255,255,.02)}

/* Live */
.live{display:grid;grid-template-columns:1fr 200px 1fr;gap:16px;align-items:center}
.side{position:relative;background:#0E1520;border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:18px;overflow:hidden}
.side::before{
  content:"";position:absolute;inset:0;
  background:radial-gradient(100% 100% at 0% 0%,rgba(255,255,255,.05),transparent 60%),
             radial-gradient(100% 100% at 100% 100%,rgba(255,255,255,.04),transparent 60%);
  pointer-events:none
}
.side .bar{display:flex;align-items:center;gap:12px;background:linear-gradient(90deg,rgba(255,255,255,.08),rgba(255,255,255,.04));padding:12px 14px;border-radius:12px}
.side .name{font-weight:800;font-size:22px;letter-spacing:.2px}
.scorebox{background:#0E1520;border:1px solid rgba(255,255,255,.12);border-radius:16px;text-align:center;padding:16px}
.score{font-size:64px;line-height:1;font-weight:800}
.badge{display:inline-block;margin:6px 0;padding:6px 12px;border-radius:999px;background:#112031;border:1px solid #203047;font-weight:800}
.time{display:inline-block;margin-top:8px;padding:8px 14px;border-radius:999px;background:#101C2C;border:1px solid #233246;font-weight:800}
.ctrls{display:flex;gap:10px;justify-content:center;margin-top:10px}
.ctrls button{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:#122034;color:var(--ink);font-weight:800;cursor:pointer}
button.primary{background:var(--accent);color:#2A1800;border:none}
.small{font-size:12px;color:var(--muted)}
.select, select{background:#0F1C2B;color:var(--ink);border:1px solid #213049;border-radius:10px;padding:10px 12px;font-weight:600}

/* Finished cards */
.list{display:grid;gap:10px}
.card{display:grid;grid-template-columns:1fr 90px 1fr;align-items:center;gap:10px;background:#0E1520;border:1px solid rgba(255,255,255,.10);border-radius:14px;padding:10px 12px}
.sidecell{display:flex;align-items:center;gap:10px;font-weight:800}
.sidecell img{width:32px;height:32px;border-radius:8px;border:1px solid rgba(255,255,255,.12)}
.center{font-weight:900;font-size:22px;text-align:center}

/* --- Phase finale (new) --- */
.grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
.bucket{background:#0E1520;border:1px solid rgba(255,255,255,.10);border-radius:16px;padding:12px}
.bucket h3{margin:0 0 10px}
.br-list{display:flex;flex-direction:column;gap:8px}
.match{
  background:#0F1928;border:1px solid rgba(255,255,255,.10);
  border-radius:12px;padding:8px 10px;
}
.teamline{
  display:grid;grid-template-columns:1fr auto;align-items:center;
  gap:8px;padding:7px 0;
}
.teamL{display:flex;align-items:center;gap:8px}
.teamL img{width:26px;height:26px;border-radius:6px;border:1px solid rgba(255,255,255,.14)}
.scoreR{font-weight:900;padding:0 6px}
.teamline + .teamline{border-top:1px solid rgba(255,255,255,.08)}
.teamline.winner{background:linear-gradient(90deg,rgba(245,158,11,.20),rgba(245,158,11,.05));}
.teamline.clickable{cursor:pointer}
.placeholder{opacity:.6}

/* Hide admin bits by default */
.admin-only{display:none}
.admin-on .admin-only{display:block}
</style>

<!-- === THEME TRANSPLANT (V8.20) — GRAPHICS ONLY === -->
<style id="theme_v820_overrides">
:root{ --accent:#ff7b00 !important; }
body{
  background: linear-gradient(135deg,
    #002654 0%, #002654 30%,
    #ffffff 50%,
    #CE1126 80%, #CE1126 100%) !important;
  background-attachment: fixed !important;
}
/* Header gradient (V8.20) — ajuste le sélecteur selon V2 */
header, header.head, .app-header{
  background: linear-gradient(90deg,
    rgba(0,38,84,0.92) 0%,  rgba(0,38,84,0.92) 30%,
    rgba(255,255,255,0.22) 50%,
    rgba(206,17,38,0.92) 80%, rgba(206,17,38,0.92) 100%) !important;
}
/* League logo 160x160 */
.event-logo, .league-logo, .league-head img{
  width:160px !important; height:160px !important; border-radius:14px !important;
}
/* Standings tiers (1–2 gold, 3–6 bronze @80%) */
#standings tbody tr:nth-child(-n+2) td{ background-color: rgba(181,143,80,0.80) !important; }
#standings tbody tr:nth-child(n+3):nth-child(-n+6) td{ background-color: rgba(152,121,75,0.80) !important; }
/* fallback if tbody not used */
#standings tr:nth-child(-n+2) td{ background-color: rgba(181,143,80,0.80) !important; }
#standings tr:nth-child(n+3):nth-child(-n+6) td{ background-color: rgba(152,121,75,0.80) !important; }
/* Pills actives sur accent */
.pill.active, .chip.active, .badge.active{ background: var(--accent) !important; color:#1a1105 !important; border-color: transparent !important; }
/* Bracket lisible (facultatif) */
.bracket .match .team, .teamline{ font-size:16px !important; line-height:1.2 !important; }
</style>
</head>
<body>
<header class="head">
  <div class="container head-grid">
    <div class="event">
      <img id="eventLogo" class="event-logo" alt="logo"/>
      <h1 id="leagueTitle" class="title">Ligue Hexa – V2</h1>
    </div>
    <nav id="mainNav" class="nav">
      <button class="pill" data-tab="classement">Classement</button>
      <button class="pill" data-tab="live">Matchs en direct</button>
      <button class="pill" data-tab="finished">Matchs terminés</button>
      <button class="pill" data-tab="manage">Gestion</button>
    </nav>
    <button id="adminBtn" class="pill admin" title="Mode admin">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px">
        <path d="M12 17a2 2 0 0 0 2-2V9a2 2 0 1 0-4 0v6a2 2 0 0 0 2 2z"/><path d="M7 9V7a5 5 0 1 1 10 0v2"/><rect x="5" y="9" width="14" height="10" rx="2"/>
      </svg>
      Admin
    </button>
  </div>
</header>

<main class="container">
  <!-- CLASSEMENT -->
  <section id="tab-classement" class="panel" hidden>
    <div class="caption">Tri : Points ▸ Diff ▸ BO ▸ BD ▸ Confrontation directe.</div>
    <div class="subnav">
      <button class="pill sub" data-sub="tableau">Classement</button>
      <button class="pill sub" data-sub="bracket">Phase finale</button>
      <button class="pill sub" data-sub="buteurs">Buteurs</button>
    </div>

    <div id="view-tableau">
      <table class="table">
        <thead><tr>
          <th class="pos">#</th><th>Équipe</th><th>J</th><th>G</th><th>N</th><th>P</th><th>BP</th><th>BC</th><th>Diff</th><th>BO</th><th>BD</th><th>Pts</th>
        </tr></thead>
        <tbody id="standings"></tbody>
      </table>
    </div>
    
    <div id="view-bracket" hidden>
      <div class="grid3">
        <div class="bucket">
          <h3>Barrages</h3>
          <div id="barrages" class="br-list"></div>
        </div>
        <div class="bucket">
          <h3>Demi-finales</h3>
          <div id="demis" class="br-list"></div>
        </div>
        <div class="bucket">
          <h3>Finale</h3>
          <div id="finale" class="br-list"></div>
        </div>
      </div>
      <div class="small" style="margin-top:8px">Clique une équipe pour la désigner vainqueur (1–0). Les vainqueurs se propagent automatiquement. Données enregistrées en local.</div>
    </div>

    <div id="view-buteurs" hidden>
      <table class="table">
        <thead><tr><th class="pos">#</th><th>Joueur</th><th>Club</th><th>Buts</th></tr></thead>
        <tbody id="scorers"></tbody>
      </table>
    </div>
  </section>

  <!-- LIVE -->
  <section id="tab-live" class="panel" hidden>
    <div class="live">
      <div class="side">
        <div class="bar"><img id="aLogo" class="logo"><div class="name" id="aName">—</div></div>
        <div class="admin-only" style="margin-top:10px">
          <label class="small">Équipe A</label>
          <select id="aSelect" class="select"></select>
          <div style="height:8px"></div>
          <label class="small">Buteur</label>
          <select id="aPlayer" class="select"></select>
          <button id="aPlus" class="primary" style="margin-left:8px">+1</button>
          <button id="aMoins">-1</button>
          <div id="aLog" class="small"></div>
        </div>
      </div>

      <div class="scorebox">
        <div class="badge">EN DIRECT</div>
        <div class="score"><span id="as">0</span> – <span id="bs">0</span></div>
        <div class="time" id="timer">00:00</div>
        <div class="ctrls admin-only">
          <button id="play">▶</button><button id="pause">⏸</button><button id="reset">↺</button>
        </div>
        <div class="ctrls admin-only">
          <button id="finish" class="primary">Match terminé</button>
          <button id="swap">Inverser</button>
        </div>
        <div class="small" id="matchId">ID —</div>
      </div>

      <div class="side">
        <div class="bar"><div class="name" id="bName">—</div><img id="bLogo" class="logo"></div>
        <div class="admin-only" style="margin-top:10px">
          <label class="small">Équipe B</label>
          <select id="bSelect" class="select"></select>
          <div style="height:8px"></div>
          <label class="small">Buteur</label>
          <select id="bPlayer" class="select"></select>
          <button id="bPlus" class="primary" style="margin-left:8px">+1</button>
          <button id="bMoins">-1</button>
          <div id="bLog" class="small"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- FINISHED -->
  <section id="tab-finished" class="panel" hidden>
    <div id="finished" class="list"></div>
  </section>

  <!-- GESTION -->
  <section id="tab-manage" class="panel" hidden>
    <h3>Gestion</h3>
    <p class="small">LocalStorage uniquement. Vous pouvez remettre à zéro ci-dessous.</p>
    <button id="wipe" class="primary">Ré-initialiser les données</button>
  </section>
</main>

<!-- Embedded teams fallback -->
<script id="teams-json" type="application/json">{
  "leagueName": "National League of Skullball",
  "eventLogo": "logos/logoevent.png",
  "teams": [
    {"id":1,"name":"Le Hollandais Violent","logo":"logos/equipe1.png","color":"#202532","players":["Sheppard","Etagon","Kz","Lama","Sqyze","Skyllocks"]},
    {"id":2,"name":"Aviron Bayonnais","logo":"logos/equipe2.png","color":"#202532","players":["Joueur 1","Joueur 2","Joueur 3","Joueur 4","Joueur 5","Joueur 6"]},
    {"id":3,"name":"Castres Olympique","logo":"logos/equipe3.png","color":"#202532","players":["Joueur 1","Joueur 2","Joueur 3","Joueur 4","Joueur 5","Joueur 6"]},
    {"id":4,"name":"Provence Rugby","logo":"logos/equipe4.png","color":"#202532","players":["Joueur 1","Joueur 2","Joueur 3","Joueur 4","Joueur 5","Joueur 6"]},
    {"id":5,"name":"RC Toulon","logo":"logos/equipe5.png","color":"#202532","players":["Joueur 1","Joueur 2","Joueur 3","Joueur 4","Joueur 5","Joueur 6"]},
    {"id":6,"name":"RC Vannes","logo":"logos/equipe6.png","color":"#202532","players":["Joueur 1","Joueur 2","Joueur 3","Joueur 4","Joueur 5","Joueur 6"]},
    {"id":7,"name":"Section Paloise","logo":"logos/equipe7.png","color":"#202532","players":["Joueur 1","Joueur 2","Joueur 3","Joueur 4","Joueur 5","Joueur 6"]},
    {"id":8,"name":"Stade Toulousain","logo":"logos/equipe8.png","color":"#202532","players":["Joueur 1","Joueur 2","Joueur 3","Joueur 4","Joueur 5","Joueur 6"]},
    {"id":9,"name":"Stade Rochelais","logo":"logos/equipe9.png","color":"#202532","players":["Joueur 1","Joueur 2","Joueur 3","Joueur 4","Joueur 5","Joueur 6"]},
    {"id":10,"name":"Perpignan","logo":"logos/equipe10.png","color":"#202532","players":["Joueur 1","Joueur 2","Joueur 3","Joueur 4","Joueur 5","Joueur 6"]},
    {"id":11,"name":"Nevers","logo":"logos/equipe11.png","color":"#202532","players":["Joueur 1","Joueur 2","Joueur 3","Joueur 4","Joueur 5","Joueur 6"]},
    {"id":12,"name":"US Montauban","logo":"logos/equipe12.png","color":"#202532","players":["Joueur 1","Joueur 2","Joueur 3","Joueur 4","Joueur 5","Joueur 6"]},
    {"id":13,"name":"Union Bordeaux Bègles","logo":"logos/equipe13.png","color":"#202532","players":["Joueur 1","Joueur 2","Joueur 3","Joueur 4","Joueur 5","Joueur 6"]},
    {"id":14,"name":"Lyon OU","logo":"logos/equipe14.png","color":"#202532","players":["Joueur 1","Joueur 2","Joueur 3","Joueur 4","Joueur 5","Joueur 6"]}
  ]
}
</script>

<script>
/* -------- Config -------- */
const DATA_URL = ""; // URL optionnelle d'un teams.json externe

/* -------- State -------- */
let TEAMS = [];
let STATS = {};
let FINISHED = JSON.parse(localStorage.getItem("sk_v2_finished")||"[]");
let ADMIN = false;
let cur = { a:null,b:null,as:0,bs:0,events:[],running:false,start:0,elapsed:0,id:rid() };

/* Bracket (winners only; entrants = auto depuis classement top6)
   Structure: {br1:{w:'a'|'b'|null}, br2:{...}, s1:{...}, s2:{...}, f:{...}} */
let BR = JSON.parse(localStorage.getItem("sk_v2_bracket")||"{}");

/* -------- Utils -------- */
const $ = (sel,ctx=document)=>ctx.querySelector(sel);
const $$ = (sel,ctx=document)=>Array.from(ctx.querySelectorAll(sel));
function rid(){ return Math.random().toString(36).slice(2,8); }
function fmt(s){ const m=String(Math.floor(s/60)).padStart(2,"0"); const z=String(Math.floor(s%60)).padStart(2,"0"); return m+':'+z; }
function T(id){ return TEAMS.find(t=>t.id==id); }
function saveLS(){ localStorage.setItem("sk_v2_finished", JSON.stringify(FINISHED)); localStorage.setItem("sk_v2_bracket", JSON.stringify(BR)); }

/* -------- Load teams -------- */
async function loadTeams(){
  let data;
  if(DATA_URL){
    try{ const r=await fetch(DATA_URL,{cache:"no-store"}); data=await r.json(); }catch(e){}
  }
  if(!data){
    try{ const r2=await fetch("teams.json",{cache:"no-store"}); if(r2.ok) data=await r2.json(); }catch(e){}
  }
  if(!data){ data = JSON.parse($("#teams-json").textContent); }
  TEAMS = data.teams||[];
  $("#leagueTitle").textContent = data.leagueName || "Ligue Hexa – V2";
  if(data.eventLogo) $("#eventLogo").src = data.eventLogo;

  // init stats
  STATS={};
  TEAMS.forEach(t=> STATS[t.id]={J:0,G:0,N:0,P:0,BP:0,BC:0,Diff:0,BO:0,BD:0,Pts:0});

  // populate selects
  const opt = TEAMS.map(t=>`<option value="${t.id}">${t.name}</option>`).join("");
  $("#aSelect").innerHTML = "<option value=''>—</option>"+opt;
  $("#bSelect").innerHTML = "<option value=''>—</option>"+opt;

  // defaults
  if(!cur.a && TEAMS.length>1){ setTeam("a", TEAMS[0].id); setTeam("b", TEAMS[1].id); }

  renderStandings(); renderBracket(); renderFinished();
}

/* -------- Tabs -------- */
function showTab(key){
  $$("#mainNav .pill").forEach(p=> p.classList.toggle("active", p.dataset.tab===key));
  $$("main > section").forEach(s=> s.hidden = !s.id.endsWith(key));
  localStorage.setItem("sk_v2_tab", key);
  if(key==="classement"){ showSub(localStorage.getItem("sk_v2_sub")||"tableau"); }
}
function showSub(k){
  $$(".subnav .pill").forEach(p=> p.classList.toggle("active", p.dataset.sub===k));
  $("#view-tableau").hidden = k!=="tableau";
  $("#view-bracket").hidden = k!=="bracket";
  $("#view-buteurs").hidden = k!=="buteurs";
  localStorage.setItem("sk_v2_sub", k);
}
document.addEventListener("click",(e)=>{
  const t=e.target.closest(".pill"); if(t && t.dataset.tab){ showTab(t.dataset.tab); }
  const s=e.target.closest(".pill.sub"); if(s && s.dataset.sub){ showSub(s.dataset.sub); }
});

/* -------- Admin -------- */
$("#adminBtn").addEventListener("click", ()=>{
  ADMIN=!ADMIN; document.body.classList.toggle("admin-on", ADMIN);
  $("#adminBtn").classList.toggle("active", ADMIN);
});

/* -------- Live -------- */
function setTeam(side, id){
  id=Number(id); if(!id) return;
  if(side==="a"){
    cur.a=id; $("#aName").textContent=T(id)?.name||"—"; $("#aLogo").src=T(id)?.logo||"";
    $("#aPlayer").innerHTML=(T(id)?.players||[]).map(p=>`<option value="${p}">${p}</option>`).join("");
  } else {
    cur.b=id; $("#bName").textContent=T(id)?.name||"—"; $("#bLogo").src=T(id)?.logo||"";
    $("#bPlayer").innerHTML=(T(id)?.players||[]).map(p=>`<option value="${p}">${p}</option>`).join("");
  }
}
$("#aSelect").addEventListener("change",(e)=>setTeam("a",e.target.value));
$("#bSelect").addEventListener("change",(e)=>setTeam("b",e.target.value));
$("#swap").addEventListener("click",()=>{ const a=cur.a,b=cur.b; setTeam("a",b); setTeam("b",a); });

function tick(){ cur.elapsed = Date.now()-cur.start; $("#timer").textContent = fmt(cur.elapsed/1000); }
let it=null;
$("#play").addEventListener("click",()=>{ if(cur.running) return; cur.running=true; cur.start=Date.now()-(cur.elapsed||0); it=setInterval(tick,250); });
$("#pause").addEventListener("click",()=>{ if(it) clearInterval(it); it=null; cur.running=false; });
$("#reset").addEventListener("click",()=>{ if(it) clearInterval(it); it=null; cur.running=false; cur.elapsed=0; $("#timer").textContent="00:00"; });

function goal(side,delta){
  if(side==="a"){ cur.as=Math.max(0,cur.as+delta); $("#as").textContent=cur.as; }
  else { cur.bs=Math.max(0,cur.bs+delta); $("#bs").textContent=cur.bs; }
}
$("#aPlus").addEventListener("click",()=>goal("a",+1)); $("#aMoins").addEventListener("click",()=>goal("a",-1));
$("#bPlus").addEventListener("click",()=>goal("b",+1)); $("#bMoins").addEventListener("click",()=>goal("b",-1));

$("#finish").addEventListener("click",()=>{
  if(!(cur.a&&cur.b)) return alert("Sélectionner les deux équipes.");
  if(it) clearInterval(it); it=null; cur.running=false;
  const m={id:cur.id,a:cur.a,b:cur.b,ga:cur.as,gb:cur.bs,events:cur.events||[],ts:Date.now(),elapsed:Math.floor((cur.elapsed||0)/1000)};
  FINISHED.push(m); saveLS();
  // stats 3/1/0
  const A=STATS[m.a], B=STATS[m.b];
  A.J++; B.J++; A.BP+=m.ga; A.BC+=m.gb; B.BP+=m.gb; B.BC+=m.ga; A.Diff=A.BP-A.BC; B.Diff=B.BP-B.BC;
  if(m.ga>m.gb){ A.G++; B.P++; A.Pts+=3; } else if(m.gb>m.ga){ B.G++; A.P++; B.Pts+=3; } else { A.N++; B.N++; A.Pts++; B.Pts++; }
  renderStandings(); renderFinished(); renderBracket();
  // reset id & score
  cur = { a:cur.a,b:cur.b,as:0,bs:0,events:[],running:false,start:0,elapsed:0,id:rid() };
  $("#as").textContent="0"; $("#bs").textContent="0"; $("#aLog").textContent=""; $("#bLog").textContent="";
  $("#matchId").textContent = "ID "+cur.id;
  $("#timer").textContent="00:00";
  alert("Match archivé.");
});
$("#matchId").textContent = "ID "+cur.id;

/* -------- Standings & scorers -------- */
function sortedRows(){
  const rows = Object.entries(STATS).map(([id,s])=>({id:Number(id),...s,name:T(id)?.name||"?",logo:T(id)?.logo||""}));
  rows.sort((a,b)=> b.Pts-a.Pts || b.Diff-a.Diff || b.BP-a.BP || a.name.localeCompare(b.name));
  return rows;
}
function renderStandings(){
  const rows = sortedRows();
  const body=$("#standings"); body.innerHTML="";
  rows.forEach((r,i)=>{
    const tr=document.createElement("tr");
    tr.className = i<6 ? "row-top" : "row-regular";
    tr.innerHTML=`
      <td class="pos">${i+1}</td>
      <td><div class="team"><img class="logo" src="${r.logo}" alt=""><div>${r.name}</div></div></td>
      <td>${r.J}</td><td>${r.G}</td><td>${r.N}</td><td>${r.P}</td>
      <td>${r.BP}</td><td>${r.BC}</td><td>${r.Diff}</td><td>${r.BO}</td><td>${r.BD}</td><td><strong>${r.Pts}</strong></td>`;
    body.appendChild(tr);
  });

  // scorers (placeholder, events non enregistrés ici)
  const sb=$("#scorers"); sb.innerHTML="";
}

/* -------- Finished list -------- */
function renderFinished(){
  const box=$("#finished"); box.innerHTML="";
  FINISHED.slice().reverse().forEach(m=>{
    const a=T(m.a)||{name:"?",logo:""}, b=T(m.b)||{name:"?",logo:""};
    const d=document.createElement("div");
    d.className="card";
    d.innerHTML=`<div class="sidecell"><img src="${a.logo}"><span>${a.name}</span></div>
                 <div class="center">${m.ga} – ${m.gb}</div>
                 <div class="sidecell" style="justify-content:end"><span>${b.name}</span><img src="${b.logo}"></div>`;
    box.appendChild(d);
  });
}

/* -------- Bracket top6: 3v5, 4v6 -> (1 v W1) & (2 v W2) -> Finale -------- */
function getSeeds(){
  const rows = sortedRows();
  return rows.slice(0,6); // top 6
}

function winnerId(matchKey, entrants){
  const w = BR[matchKey]?.w || null;
  if(!w) return null;
  const m = entrants[matchKey];
  const team = (w==='a'? m.a : m.b);
  return team && team.id ? team.id : null;
}

function clearIfTeamChanged(oldId, newId, matchKey){
  if(!oldId) return;
  if(oldId !== newId){
    // reset downstream match selection if it referenced old winner
    if(BR[matchKey]) BR[matchKey].w = null;
  }
}

function renderBracket(){
  const seeds = getSeeds(); // 1..6
  const s1 = seeds[0], s2 = seeds[1], s3 = seeds[2], s4 = seeds[3], s5 = seeds[4], s6 = seeds[5];

  const entrants = {
    br1: { a:s3||null, b:s5||null },
    br2: { a:s4||null, b:s6||null },
    s1:  { a:s1||null, b:null },
    s2:  { a:s2||null, b:null },
    f:   { a:null, b:null }
  };

  // Propagate known winners
  const w1 = s3&&s5 ? winnerId('br1', entrants) : null;
  const w2 = s4&&s6 ? winnerId('br2', entrants) : null;

  entrants.s1.b = w1 ? { ...(T(w1)||{}), id:w1, name:T(w1)?.name||"?",
                         logo:T(w1)?.logo||"" } : null;
  entrants.s2.b = w2 ? { ...(T(w2)||{}), id:w2, name:T(w2)?.name||"?",
                         logo:T(w2)?.logo||"" } : null;

  const wS1 = (entrants.s1.a && entrants.s1.b) ? winnerId('s1', entrants) : null;
  const wS2 = (entrants.s2.a && entrants.s2.b) ? winnerId('s2', entrants) : null;

  entrants.f.a = wS1 ? { ...(T(wS1)||{}), id:wS1, name:T(wS1)?.name||"?", logo:T(wS1)?.logo||"" } : null;
  entrants.f.b = wS2 ? { ...(T(wS2)||{}), id:wS2, name:T(wS2)?.name||"?", logo:T(wS2)?.logo||"" } : null;

  // Build UI
  const mk = (key, label)=>{
    const m = entrants[key];
    const wrap = document.createElement('div');
    wrap.className = 'match';
    // rows
    const r1 = document.createElement('div');
    r1.className = 'teamline '+(m.a?'clickable':'')+' '+(BR[key]?.w==='a'?'winner':'');
    r1.addEventListener('click',()=>{ if(!m.a) return; BR[key]=BR[key]||{}; BR[key].w='a'; saveLS(); renderBracket(); });
    r1.innerHTML = `<div class="teamL ${m.a?'':'placeholder'}">${m.a? `<img src="${m.a.logo||''}"><span>${m.a.name}</span>`:'—'}</div>
                    <div class="scoreR">${BR[key]?.w==='a' ? '1' : '0'}</div>`;

    const r2 = document.createElement('div');
    r2.className = 'teamline '+(m.b?'clickable':'')+' '+(BR[key]?.w==='b'?'winner':'');
    r2.addEventListener('click',()=>{ if(!m.b) return; BR[key]=BR[key]||{}; BR[key].w='b'; saveLS(); renderBracket(); });
    r2.innerHTML = `<div class="teamL ${m.b?'':'placeholder'}">${m.b? `<img src="${m.b.logo||''}"><span>${m.b.name}</span>`:'—'}</div>
                    <div class="scoreR">${BR[key]?.w==='b' ? '1' : '0'}</div>`;

    wrap.appendChild(r1); wrap.appendChild(r2);
    return wrap;
  };

  // Render columns
  const b = $("#barrages"); b.innerHTML='';
  const d = $("#demis"); d.innerHTML='';
  const f = $("#finale"); f.innerHTML='';

  b.appendChild(mk('br1'));
  b.appendChild(mk('br2'));
  d.appendChild(mk('s1'));
  d.appendChild(mk('s2'));
  f.appendChild(mk('f'));
}

/* -------- Manage -------- */
$("#wipe").addEventListener("click",()=>{
  if(!confirm("Tout ré-initialiser ?")) return;
  FINISHED=[];
  BR={};
  localStorage.removeItem("sk_v2_finished");
  localStorage.removeItem("sk_v2_bracket");
  Object.keys(STATS).forEach(id=> STATS[id]={J:0,G:0,N:0,P:0,BP:0,BC:0,Diff:0,BO:0,BD:0,Pts:0});
  renderStandings(); renderFinished(); renderBracket();
});

/* -------- Boot -------- */
$$("#mainNav .pill").forEach(b=> b.addEventListener("click",()=>showTab(b.dataset.tab)));
function boot(){
  const saved = localStorage.getItem("sk_v2_tab");
  const valid = ["classement","live","finished","manage"];
  showTab(valid.includes(saved)? saved : "classement");
  showSub(localStorage.getItem("sk_v2_sub")||"tableau");
  loadTeams();
}
boot();
</script>
</body>
</html>
