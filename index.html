<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Skullball – Fusion V1 (V8.20) + V2 (V13)</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg-dark:#0C131B;
  --panel:#111823;
  --ink:#EAF0FB;
  --muted:#9CA9BB;
  --accent:#FF7B00; /* accent V8.20 */
  --pill:#1B2432;
  --pill-border:#2A3647;
  --pill-hover:#222E40;
  --gold1:#D3AD6B;
  --gold2:#B18753;
  --row-sep:#1E2A3A;
  --ok:#22C55E;
  --danger:#EF4444;
}

/* Base */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  color:var(--ink);
  background:linear-gradient(135deg,#002654 0%,#002654 30%,#ffffff 50%,#CE1126 80%,#CE1126 100%);
  background-attachment:fixed;
}
.container{max-width:1600px;margin:0 auto;padding:0 16px}
@media (min-width:1600px){ .container{ max-width:92vw } }

/* Header (V13) */
header.head{
  position:sticky;top:0;z-index:100;
  padding:14px 0;
  border-bottom:1px solid rgba(255,255,255,.08);
  background:linear-gradient(90deg,rgba(0,38,84,.92) 0%,rgba(0,38,84,.75) 40%,rgba(255,255,255,.14) 60%,rgba(206,17,38,.36) 78%,rgba(206,17,38,.62) 100%);
  backdrop-filter:blur(8px);
}
.head-grid{display:grid;grid-template-columns:auto 1fr auto;gap:20px;align-items:center}
.event{display:flex;align-items:center;gap:12px}
.event-logo{
  width:64px;height:64px;border-radius:12px;object-fit:cover;
  background:#0b121c;border:1px solid rgba(255,255,255,.12);
  box-shadow:0 8px 22px rgba(0,0,0,.35);
}
h1.title{margin:0;font-weight:800;font-size:22px;letter-spacing:.2px;text-shadow:0 2px 8px rgba(0,0,0,.35)}

/* Nav pills (V13) */
.nav{display:flex;gap:10px;flex-wrap:wrap}
.pill{
  height:40px;display:inline-flex;align-items:center;gap:10px;
  padding:0 16px;border-radius:14px;
  background:var(--pill);
  border:1px solid var(--pill-border);
  color:var(--ink);font-weight:700;cursor:pointer;user-select:none;
  transition:transform .06s ease, background .15s ease, color .15s ease, border-color .15s ease;
}
.pill:hover{background:var(--pill-hover);transform:translateY(-1px)}
.pill.active{background:var(--accent);color:#1a1105;border-color:transparent}
.admin-btn{justify-self:end}

/* Main */
main{padding:22px 0 64px}
.panel{
  background:linear-gradient(180deg,rgba(10,14,20,.92),rgba(10,14,20,.92)) padding-box;
  border:1px solid rgba(255,255,255,.10);
  border-radius:18px;padding:18px;box-shadow:0 10px 32px rgba(0,0,0,.35)
}
.caption{color:var(--muted);font-size:14px;margin-bottom:10px}

/* Subnav (V13) */
.subnav{display:flex;gap:8px;margin-bottom:12px}
.subnav .pill{height:32px;padding:0 12px;border-radius:999px;background:#0F1723;border-color:#233046}
.subnav .pill.active{background:var(--accent);color:#1a1105}

/* ======= CLASSEMENT (V8.20 table look) ======= */
.table{width:100%;border-collapse:collapse}
.table thead th{
  font-size:14px;text-align:left;padding:12px 10px;color:#DDE8F8;border-bottom:1px solid rgba(255,255,255,.08)
}
.table tbody td{padding:16px 10px;border-bottom:1px solid rgba(255,255,255,.06);font-size:15px}
.table .pos{width:40px;font-weight:800;color:#fff}
.team{display:flex;align-items:center;gap:12px}
.logo{width:48px;height:48px;border-radius:12px;object-fit:cover;background:#0a0f16;border:1px solid rgba(255,255,255,.14)}
/* Exact standings colors (V8.20 V8.8) */
#standings tbody tr:nth-child(-n+2) td{ background-color: rgba(181,143,80,0.80) !important; } /* #b58f50 */
#standings tbody tr:nth-child(n+3):nth-child(-n+6) td{ background-color: rgba(152,121,75,0.80) !important; } /* #98794b */

/* ======= LIVE (V8.20 card layout) ======= */
.live-list{display:grid;grid-template-columns:1fr;gap:14px}
.match-card{border-radius:18px;overflow:hidden;box-shadow:0 8px 24px rgba(0,0,0,.35);border:1px solid #252a39;background:#101725}
.row{display:grid;grid-template-columns:96px 1fr auto 1fr 96px;align-items:center}
.cell{padding:14px 16px;background:linear-gradient(180deg,#111521,#0c0f18)}
.cell.mid{background:linear-gradient(180deg,#151a26,#10141f); text-align:center}
.badge{font-size:12px;color:#fff;background:rgba(255,255,255,.08);border:1px solid #2b3347;padding:6px 10px;border-radius:999px}
.teamline{display:flex;align-items:center;gap:12px}
.teamline img{width:72px;height:72px;border-radius:50%;object-fit:cover;border:2px solid #30384b;background:#0e111a}
.teamline .name{font-weight:900;font-size:20px}
.score{font-size:52px;font-weight:1000;letter-spacing:1px}
.timer{display:inline-block;margin-top:6px;font-size:24px;font-weight:900;padding:6px 10px;border-radius:12px;border:1px solid #2b3347;background:rgba(255,255,255,.06)}
.status{font-size:12px;font-weight:900;text-transform:uppercase;padding:6px 10px;border-radius:999px;border:1px solid #2b3347;background:rgba(255,255,255,.06)}
/* background half logos */
.row{position:relative}
.bg-half{position:absolute;top:0;bottom:0;width:50%;background-repeat:no-repeat;background-position:center;background-size:70% auto;opacity:.06;filter:grayscale(100%);pointer-events:none;z-index:0}
.bg-half.left{left:0}
.bg-half.right{right:0}
.cell{position:relative;z-index:1}

/* Lower black band controls */
.footer{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:#0b0f18;color:var(--muted);border-top:1px solid rgba(255,255,255,.10)}
.controls{display:flex;gap:8px;flex-wrap:wrap}
.mini{padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:#122034;color:var(--ink);font-weight:800;cursor:pointer}
.mini:hover{background:#182741}
.mini.primary{background:var(--accent);color:#1a1105;border:none}
.players{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;min-width:260px}
.players .btn{padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:#0f1b2a;color:var(--ink);font-weight:800;cursor:pointer}
.players .btn:hover{background:#12243a}

/* Goal chips under team names */
.scorers-strip{ display:inline-flex; gap:8px; flex-wrap:wrap; background:#0f1220; border:1px solid #2b3344; border-radius:8px; padding:6px 8px; margin-top:6px }
.scorers-strip .chip{ background:#1a1f2f; border:1px solid #2b3344; border-radius:16px; padding:2px 8px; font-size:12px; color:#d6deff; }

/* ======= FINISHED ======= */
.filterbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
.chip{padding:8px 10px;border-radius:999px;border:1px solid #2b3347;background:#1a1f2b;color:var(--ink);cursor:pointer}
.chip.active{background:var(--accent);color:#1a1105;border-color:transparent}
/* reuse .match-card compact */
.finished-list .match-card .teamline img{width:40px;height:40px;border-radius:10px}
.finished-list .match-card .score{font-size:36px}

/* ======= PHASE FINALE ======= */
.grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
.bucket{background:#0E1520;border:1px solid rgba(255,255,255,.10);border-radius:16px;padding:12px}
.bucket h3{margin:0 0 10px}
.br-list{display:flex;flex-direction:column;gap:8px}
.br-match{background:#0F1928;border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:8px 10px}
.br-line{display:grid;grid-template-columns:1fr auto;align-items:center;gap:8px;padding:7px 0}
.br-line + .br-line{border-top:1px solid rgba(255,255,255,.08)}
.br-team{display:flex;align-items:center;gap:8px}
.br-team img{width:26px;height:26px;border-radius:6px;border:1px solid rgba(255,255,255,.14)}
.br-score{font-weight:900;padding:0 6px}
.br-line.winner{background:linear-gradient(90deg,rgba(245,158,11,.20),rgba(245,158,11,.05))}

/* ======= Admin badge & panel ======= */
#adminBadge{display:inline-flex;align-items:center;gap:8px}
#adminBadge .pill{height:32px}
#adminPanel{margin-top:12px}
.form{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.form label{font-size:13px;color:var(--muted)}
.input, select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #2b3347;background:#151a24;color:var(--ink);font-size:15px}
.btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;background:#1f2430;border:1px solid #2b3344;color:var(--ink);cursor:pointer;font-weight:700}
.btn.primary{background:var(--accent);color:#1a1105;border:none}
.hidden{display:none !important}
.center{text-align:center}
</style>
</head>
<body>
<header class="head">
  <div class="container head-grid">
    <div class="event">
      <img id="eventLogo" class="event-logo" alt="logo"/>
      <h1 id="leagueTitle" class="title">Ligue Hexa</h1>
    </div>
    <nav id="mainNav" class="nav">
      <button class="pill active" data-tab="classement">Classement</button>
      <button class="pill" data-tab="live">Matchs en direct</button>
      <button class="pill" data-tab="finished">Matchs terminés</button>
      <button class="pill" data-tab="knockout">Phase finale</button>
      <!-- Gestion tab removed -->
    </nav>
    <div class="admin-btn">
      <button id="adminToggle" class="pill" title="Règles & options">Admin</button>
    </div>
  </div>
</header>

<main class="container">
  <!-- CLASSEMENT -->
  <section id="tab-classement" class="panel">
    <div class="caption">Tri : Points ▸ Diff ▸ BP.</div>
    <div class="subnav">
      <button class="pill sub active" data-sub="tableau">Classement</button>
      <button class="pill sub" data-sub="bracket">Phase finale</button>
      <button class="pill sub" data-sub="buteurs">Buteurs</button>
    </div>

    <div id="view-tableau">
      <table id="standings" class="table">
        <thead><tr>
          <th class="pos">#</th><th>Équipe</th><th>J</th><th>G</th><th>N</th><th>P</th><th>BP</th><th>BC</th><th>Diff</th><th>Pts</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="view-bracket" class="hidden">
      <div class="grid3" id="bracket">
        <div class="bucket">
          <h3>Quarts</h3>
          <div class="br-list" id="qf"></div>
        </div>
        <div class="bucket">
          <h3>Demi-finales</h3>
          <div class="br-list" id="sf"></div>
        </div>
        <div class="bucket">
          <h3>Finale</h3>
          <div class="br-list" id="fi"></div>
        </div>
      </div>
    </div>

    <div id="view-buteurs" class="hidden">
      <table id="scorers" class="table">
        <thead><tr><th class="pos">#</th><th>Joueur</th><th>Équipe</th><th>Buts</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="adminPanel" class="hidden">
      <h3>Règles & options</h3>
      <div class="form">
        <div><label>Durée match (min)</label><input class="input" id="ruleDuration" type="number" min="1" value="15"></div>
        <div><label>Points victoire</label><input class="input" id="ruleWin" type="number" min="0" value="3"></div>
        <div><label>Points nul</label><input class="input" id="ruleDraw" type="number" min="0" value="1"></div>
        <div><label>Points défaite</label><input class="input" id="ruleLoss" type="number" min="0" value="0"></div>
        <div><label>Activer bonus large</label>
          <select class="input" id="ruleBonus"><option value="1">Oui</option><option value="0">Non</option></select>
        </div>
        <div><label>Seuil bonus (diff. ≥)</label><input class="input" id="ruleBonusThr" type="number" min="1" value="3"></div>
        <div><label>Points bonus</label><input class="input" id="ruleBonusPts" type="number" min="0" value="1"></div>
      </div>
      <div style="margin-top:10px"><button id="saveRules" class="btn primary">Enregistrer</button></div>
    </div>
  </section>

  <!-- LIVE -->
  <section id="tab-live" class="panel hidden">
    <div id="liveList" class="live-list"></div>
  </section>

  <!-- FINISHED -->
  <section id="tab-finished" class="panel hidden">
    <div id="finishedFilter" class="filterbar"></div>
    <div id="finishedList" class="finished-list live-list"></div>
  </section>

  <!-- PHASE FINALE (alt view) -->
  <section id="tab-knockout" class="panel hidden">
    <div class="caption">Vue globale des phases finales.</div>
    <div class="grid3">
      <div class="bucket"><h3>Quarts</h3><div class="br-list" id="qf2"></div></div>
      <div class="bucket"><h3>Demi-finales</h3><div class="br-list" id="sf2"></div></div>
      <div class="bucket"><h3>Finale</h3><div class="br-list" id="fi2"></div></div>
    </div>
  </section>
</main>

<script>
/* ========= Helpers ========= */
const $ = (s,r=document)=>r.querySelector(s);
const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
const byId = id => document.getElementById(id);
const fmt2 = n => String(n).padStart(2,'0');
const isNullPlayer = (name) => {
  if(!name) return true;
  const s = String(name).trim().toLowerCase().replace(/[^a-z]/g,'');
  return ['null','nul','none','vide'].includes(s);
};

/* ========= State ========= */
const state = {
  event:{ name:'Tournoi', logo:'' },
  teams:[], // {id,name,logo,color,players[<=6]}
  schedule:[], // matches
  rules:{ duration:15, win:3, draw:1, loss:0, bonus:true, bonusThr:3, bonusPts:1 },
  standings:new Map(), // id->{played,win,draw,loss,gf,ga,pts}
  scorers:new Map(), // key teamId::player -> {player, teamId, goals}
};

function playerKey(teamId, player){ return teamId + '::' + player }

/* ========= Data load ========= */
async function loadData(){
  const res = await fetch('team.json', {cache:'no-cache'});
  if(!res.ok){ throw new Error('team.json introuvable'); }
  const data = await res.json();
  state.event = data.event || state.event;
  state.teams = (data.teams||[]).map(t=>({
    id:t.id, name:t.name, logo:t.logo||'', color:t.color||'#1a2535',
    players: Array.isArray(t.players) ? t.players.slice(0,6) : []
  }));

  // Header
  byId('leagueTitle').textContent = state.event.name || 'Tournoi';
  if(state.event.logo){ byId('eventLogo').src = state.event.logo; }

  // Init standings
  state.standings.clear();
  state.teams.forEach(t=> state.standings.set(t.id, {played:0,win:0,draw:0,loss:0,gf:0,ga:0,pts:0}) );

  // Generate single round-robin (phase aller)
  state.schedule = generateRR(state.teams.map(t=>t.id)).map((p,idx)=>({
    id:`${p.a}-${p.b}-${idx+1}`,
    day:p.day,
    a:p.a, b:p.b,
    status:'upcoming', scoreA:0, scoreB:0,
    goals:[], forfeited:null,
    remaining: state.rules.duration*60, startTs:null
  }));

  renderAll();
}

/* Round-robin (circle method) */
function generateRR(ids){
  const arr = ids.slice();
  if(arr.length % 2 === 1) arr.push('BYE');
  const n = arr.length, rounds = n-1, half = n/2;
  const fixed = arr[0];
  let others = arr.slice(1);
  const fixtures = [];
  for(let r=0;r<rounds;r++){
    const left = [fixed].concat(others.slice(0,half-1));
    const right = others.slice(half-1).reverse();
    for(let i=0;i<half;i++){
      const a = left[i], b = right[i];
      if(a!=='BYE' && b!=='BYE') fixtures.push({day:r+1, a, b});
    }
    others = [others[others.length-1]].concat(others.slice(0,others.length-1));
  }
  return fixtures;
}

/* ========= Navigation ========= */
function initNav(){
  byId('mainNav').addEventListener('click', (e)=>{
    const b = e.target.closest('.pill'); if(!b) return;
    $$('#mainNav .pill').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    const tab = b.dataset.tab;
    ['classement','live','finished','knockout'].forEach(t=>{
      byId(`tab-${t}`).classList.toggle('hidden', t!==tab);
    });
  });

  // Subtabs
  $('.subnav').addEventListener('click', (e)=>{
    const b = e.target.closest('.pill'); if(!b) return;
    $$('.subnav .pill').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    const sub = b.dataset.sub;
    byId('view-tableau').classList.toggle('hidden', sub!=='tableau');
    byId('view-bracket').classList.toggle('hidden', sub!=='bracket');
    byId('view-buteurs').classList.toggle('hidden', sub!=='buteurs');
  });

  // Admin toggle
  byId('adminToggle').addEventListener('click', ()=>{
    byId('adminPanel').classList.toggle('hidden');
  });

  // Save rules
  byId('saveRules').addEventListener('click', ()=>{
    state.rules.duration = Math.max(1, parseInt(byId('ruleDuration').value||'15',10));
    state.rules.win = parseInt(byId('ruleWin').value||'3',10);
    state.rules.draw = parseInt(byId('ruleDraw').value||'1',10);
    state.rules.loss = parseInt(byId('ruleLoss').value||'0',10);
    state.rules.bonus = (byId('ruleBonus').value==='1');
    state.rules.bonusThr = parseInt(byId('ruleBonusThr').value||'3',10);
    state.rules.bonusPts = parseInt(byId('ruleBonusPts').value||'1',10);
    // reset remaining for not-started matches
    state.schedule.forEach(m=>{ if(m.status==='upcoming'){ m.remaining = state.rules.duration*60; } });
    renderStandings();
    alert('Règles enregistrées');
  });
}

/* ========= Rendering ========= */
function renderAll(){
  renderStandings();
  buildLive();
  buildFinished();
  renderScorers();
  buildBracketPlaceholders();
}

function renderStandings(){
  // recompute
  state.standings.forEach((_,id)=> state.standings.set(id,{played:0,win:0,draw:0,loss:0,gf:0,ga:0,pts:0}));
  state.schedule.filter(m=>m.status==='done').forEach(m=>{
    const a = state.standings.get(m.a), b = state.standings.get(m.b);
    a.played++; b.played++; a.gf+=m.scoreA; a.ga+=m.scoreB; b.gf+=m.scoreB; b.ga+=m.scoreA;
    if(m.scoreA>m.scoreB){ a.win++; b.loss++; a.pts+=state.rules.win; b.pts+=state.rules.loss;
      if(state.rules.bonus && (m.scoreA-m.scoreB)>=state.rules.bonusThr) a.pts+=state.rules.bonusPts;
    } else if(m.scoreA<m.scoreB){ b.win++; a.loss++; b.pts+=state.rules.win; a.pts+=state.rules.loss;
      if(state.rules.bonus && (m.scoreB-m.scoreA)>=state.rules.bonusThr) b.pts+=state.rules.bonusPts;
    } else { a.draw++; b.draw++; a.pts+=state.rules.draw; b.pts+=state.rules.draw; }
  });

  const rows = Array.from(state.standings.entries()).map(([id,s])=>{
    const t = state.teams.find(x=>x.id===id) || {name:id,logo:''};
    return { id, name:t.name, logo:t.logo, played:s.played, win:s.win, draw:s.draw, loss:s.loss, gf:s.gf, ga:s.ga, diff:s.gf-s.ga, pts:s.pts };
  }).sort((x,y)=> y.pts-x.pts || (y.diff - x.diff) || (y.gf - x.gf) || x.name.localeCompare(y.name));

  const tbody = byId('standings').querySelector('tbody');
  tbody.innerHTML = rows.map((r,i)=>`
    <tr>
      <td class="pos">${i+1}</td>
      <td><div class="team"><img class="logo" src="${r.logo}" alt=""><strong>${r.name}</strong></div></td>
      <td>${r.played}</td><td>${r.win}</td><td>${r.draw}</td><td>${r.loss}</td>
      <td>${r.gf}</td><td>${r.ga}</td><td>${r.diff}</td><td><strong>${r.pts}</strong></td>
    </tr>
  `).join('');
}

function renderScorers(){
  const list = Array.from(state.scorers.values()).sort((a,b)=> b.goals-a.goals || a.player.localeCompare(b.player));
  const tbody = byId('scorers').querySelector('tbody');
  tbody.innerHTML = list.map((s,i)=>{
    const team = state.teams.find(t=>t.id===s.teamId);
    return `<tr>
      <td class="pos">${i+1}</td>
      <td>${s.player}</td>
      <td><div class="team"><img class="logo" src="${team?.logo||''}" alt=""><strong>${team?.name||s.teamId}</strong></div></td>
      <td><strong>${s.goals}</strong></td>
    </tr>`;
  }).join('');
}

function buildLive(){
  const box = byId('liveList');
  box.innerHTML = '';
  // group by day
  const days = [...new Set(state.schedule.map(m=>m.day))];
  days.forEach(day=>{
    // banner "Journée X"
    const banner = document.createElement('div');
    banner.className = 'badge'; banner.textContent = 'Journée ' + day;
    box.appendChild(banner);
    state.schedule.filter(m=>m.day===day).forEach(m=> box.appendChild(liveCard(m)));
  });
}

function liveCard(m){
  const tA = state.teams.find(t=>t.id===m.a), tB = state.teams.find(t=>t.id===m.b);
  const card = document.createElement('div'); card.className='match-card';
  const row = document.createElement('div'); row.className='row';
  const bgL = document.createElement('div'); bgL.className='bg-half left'; bgL.style.backgroundImage = tA.logo?`url('${tA.logo}')`:'none';
  const bgR = document.createElement('div'); bgR.className='bg-half right'; bgR.style.backgroundImage = tB.logo?`url('${tB.logo}')`:'none';

  const left = document.createElement('div'); left.className='cell'; left.style.background = tA.color ? `linear-gradient(180deg, ${hexA(tA.color, .40)}, rgba(0,0,0,.25))` : '';
  left.innerHTML = `<div class="teamline"><img src="${tA.logo}"><div><div class="name">${tA.name}</div><div class="scorers-strip" data-side="a"></div></div></div>`;

  const midL = document.createElement('div'); midL.className='cell mid center';
  midL.innerHTML = `<div class="badge">Journée ${m.day}</div><div class="status">${labelStatus(m.status)}</div>`;

  const mid = document.createElement('div'); mid.className='cell mid center';
  mid.innerHTML = `<div class="score">${m.scoreA} – ${m.scoreB}</div><div class="timer" data-clock>${fmt2(Math.floor(m.remaining/60))}:${fmt2(m.remaining%60)}</div>`;

  const midR = document.createElement('div'); midR.className='cell mid center';
  midR.innerHTML = `<div class="badge">${m.status==='live'?'En cours':(m.status==='done'?'Terminé':'À venir')}</div>`;

  const right = document.createElement('div'); right.className='cell'; right.style.background = tB.color ? `linear-gradient(180deg, ${hexA(tB.color, .40)}, rgba(0,0,0,.25))` : '';
  right.innerHTML = `<div class="teamline" style="justify-content:flex-end"><div><div class="name" style="text-align:right">${tB.name}</div><div class="scorers-strip" data-side="b" style="justify-content:flex-end"></div></div><img src="${tB.logo}"></div>`;

  row.append(bgL,bgR,left,midL,mid,midR,right);

  // footer band with controls
  const footer = document.createElement('div'); footer.className='footer';
  const leftCtrls = document.createElement('div'); leftCtrls.className='controls';
  const rightCtrls = document.createElement('div'); rightCtrls.className='controls';
  const centerCtrls = document.createElement('div'); centerCtrls.className='controls';

  // Left players + minus + forfait (for A)
  const minusA = makeMini('−', ()=> removeLastGoal(m,'a',card));
  const forfaitA = makeMini('F', ()=> forfeit(m,'a',card));
  leftCtrls.append(minusA, forfaitA, playersGrid('a', m, tA, card));

  // Center play/pause/reset + finish
  const play = makeMini('▶️ Play', ()=> startMatch(m, card)); play.classList.add('primary');
  const pause = makeMini('⏸ Pause', ()=> pauseMatch(m));
  const reset = makeMini('⟲ Reset', ()=> resetMatch(m, card));
  const finish = makeMini('✅ Match terminé', ()=> finishMatch(m, card, false));
  centerCtrls.append(play, pause, reset, finish);

  // Right players + minus + forfait (for B)
  const minusB = makeMini('−', ()=> removeLastGoal(m,'b',card));
  const forfaitB = makeMini('F', ()=> forfeit(m,'b',card));
  rightCtrls.append(playersGrid('b', m, tB, card), minusB, forfaitB);

  footer.append(leftCtrls, centerCtrls, rightCtrls);

  card.append(row, footer);
  card._refs = {
    score: mid.querySelector('.score'),
    clock: mid.querySelector('[data-clock]'),
    statusL: midL.querySelector('.status'),
    leftStrip: left.querySelector('[data-side="a"]'),
    rightStrip: right.querySelector('[data-side="b"]'),
  };
  return card;
}

function playersGrid(side, m, team, card){
  const wrap = document.createElement('div'); wrap.className='players';
  (team.players||[]).forEach(p=>{
    if(isNullPlayer(p)) return;
    const b = document.createElement('button');
    b.className='btn'; b.textContent = p;
    b.addEventListener('click', ()=> scoreGoal(m, side, p, card));
    wrap.appendChild(b);
  });
  return wrap;
}

/* Finished */
function buildFinished(){
  const f = byId('finishedList');
  const filter = byId('finishedFilter');
  f.innerHTML=''; filter.innerHTML='';

  const days = [...new Set(state.schedule.filter(m=>m.status==='done').map(m=>m.day))].sort((a,b)=>a-b);
  const allChip = chip('Tous', true, ()=> renderFinished('all')); filter.appendChild(allChip);
  days.forEach(d=> filter.appendChild(chip('Journée '+d, false, ()=> renderFinished(String(d))) ));
  renderFinished('all');
}
function chip(label, active, onClick){
  const c = document.createElement('button'); c.className='chip' + (active?' active':'');
  c.textContent = label; c.addEventListener('click', ()=>{ $$('#finishedFilter .chip').forEach(x=>x.classList.remove('active')); c.classList.add('active'); onClick(); });
  return c;
}
function renderFinished(dayFilter){
  const f = byId('finishedList'); f.innerHTML='';
  const list = state.schedule.filter(m=> m.status==='done' && (dayFilter==='all' || String(m.day)===String(dayFilter)));
  if(list.length===0){ f.innerHTML = '<div class="center" style="opacity:.8">Aucun match terminé.</div>'; return; }
  list.forEach(m=> f.appendChild(readOnlyCard(m)));
}
function readOnlyCard(m){
  const tA = state.teams.find(t=>t.id===m.a), tB = state.teams.find(t=>t.id===m.b);
  const card = document.createElement('div'); card.className='match-card';
  const row = document.createElement('div'); row.className='row';
  const bgL = document.createElement('div'); bgL.className='bg-half left'; bgL.style.backgroundImage = tA.logo?`url('${tA.logo}')`:'none';
  const bgR = document.createElement('div'); bgR.className='bg-half right'; bgR.style.backgroundImage = tB.logo?`url('${tB.logo}')`:'none';

  const left = document.createElement('div'); left.className='cell'; left.style.background = tA.color ? `linear-gradient(180deg, ${hexA(tA.color, .35)}, rgba(0,0,0,.20))` : '';
  left.innerHTML = `<div class="teamline"><img src="${tA.logo}"><div><div class="name">${tA.name}</div><div class="scorers-strip" data-side="a"></div></div></div>`;

  const mid = document.createElement('div'); mid.className='cell mid center';
  mid.innerHTML = `<div class="badge">Terminé – Journée ${m.day}</div><div class="score">${m.scoreA} – ${m.scoreB}</div>`;

  const right = document.createElement('div'); right.className='cell'; right.style.background = tB.color ? `linear-gradient(180deg, ${hexA(tB.color, .35)}, rgba(0,0,0,.20))` : '';
  right.innerHTML = `<div class="teamline" style="justify-content:flex-end"><div><div class="name" style="text-align:right">${tB.name}</div><div class="scorers-strip" data-side="b" style="justify-content:flex-end"></div></div><img src="${tB.logo}"></div>`;

  row.append(bgL,bgR,left,mid,right);
  card.append(row);

  // chips
  const strips = { a: left.querySelector('[data-side="a"]'), b: right.querySelector('[data-side="b"]') };
  m.goals.forEach(g=>{
    const chip = document.createElement('span'); chip.className='chip'; chip.textContent = `⚽ ${g.player} ${g.minute}'`;
    strips[g.team].appendChild(chip);
  });
  return card;
}

/* ========= Match flow ========= */
let timerId = null;
function startMatch(m, card){
  if(m.status==='done') return;
  if(!m.startTs) m.startTs = Date.now();
  m.status='live'; tick(card, m);
  if(timerId) clearInterval(timerId);
  timerId = setInterval(()=>{
    if(m.remaining>0){ m.remaining--; tick(card,m); }
    else{ clearInterval(timerId); timerId=null; finishMatch(m, card, true); }
  }, 1000);
}
function pauseMatch(m){
  if(m.status!=='live') return;
  m.status='upcoming'; // paused behaves like not-live
}
function resetMatch(m, card){
  if(timerId){ clearInterval(timerId); timerId=null; }
  m.status='upcoming'; m.startTs=null; m.remaining=state.rules.duration*60;
  m.scoreA=0; m.scoreB=0; m.goals=[]; m.forfeited=null;
  tick(card, m, true);
}
function finishMatch(m, card, natural){
  if(timerId){ clearInterval(timerId); timerId=null; }
  m.status='done';
  if(m.forfeited){
    if(m.forfeited==='a'){ m.scoreA=0; m.scoreB=3; }
    if(m.forfeited==='b'){ m.scoreA=3; m.scoreB=0; }
    m.goals=[];
  }
  tick(card, m);
  // standings & scorers
  applyScorers(m);
  renderScorers();
  renderStandings();
  buildFinished();
}
function forfeit(m, side, card){
  if(m.status==='done') return;
  m.forfeited = side;
  finishMatch(m, card, false);
}
function scoreGoal(m, side, player, card){
  if(m.status!=='live'){ startMatch(m, card); } // start if not live
  const minute = state.rules.duration - Math.floor(m.remaining/60);
  if(side==='a') m.scoreA++; else m.scoreB++;
  m.goals.push({team:side, player, minute});
  if(timerId){ clearInterval(timerId); timerId=null; } // stop clock
  m.status='live';
  tick(card, m);
}
function removeLastGoal(m, side, card){
  for(let i=m.goals.length-1;i>=0;i--){
    if(m.goals[i].team===side){
      if(side==='a') m.scoreA = Math.max(0, m.scoreA-1); else m.scoreB = Math.max(0, m.scoreB-1);
      m.goals.splice(i,1); break;
    }
  }
  tick(card, m, true);
}
function tick(card, m, rebuild=false){
  if(!card || !card._refs) return;
  const {score, clock, statusL, leftStrip, rightStrip} = card._refs;
  score.textContent = `${m.scoreA} – ${m.scoreB}`;
  if(clock) clock.textContent = `${fmt2(Math.floor(m.remaining/60))}:${fmt2(m.remaining%60)}`;
  if(statusL) statusL.textContent = labelStatus(m.status);
  if(rebuild){ leftStrip.innerHTML=''; rightStrip.innerHTML=''; }
  leftStrip.innerHTML=''; rightStrip.innerHTML='';
  m.goals.forEach(g=>{
    const chip = document.createElement('span'); chip.className='chip'; chip.textContent = `⚽ ${g.player} ${g.minute}'`;
    (g.team==='a'?leftStrip:rightStrip).appendChild(chip);
  });
}
function labelStatus(s){ return s==='live' ? 'EN COURS' : (s==='done' ? 'TERMINÉ' : 'À VENIR'); }
function applyScorers(m){
  if(m.forfeited) return;
  m.goals.forEach(g=>{
    const teamId = (g.team==='a') ? m.a : m.b;
    const key = playerKey(teamId, g.player);
    const rec = state.scorers.get(key) || {player:g.player, teamId, goals:0};
    rec.goals += 1; state.scorers.set(key, rec);
  });
}

/* ========= Phase finale placeholders ========= */
function buildBracketPlaceholders(){
  const make = (c,id)=>{ byId(id).innerHTML = c.map(x=>`
    <div class="br-match">
      <div class="br-line ${x.winner==='a'?'winner':''}">
        <div class="br-team"><img src="${(teamById(x.a)||{}).logo||''}"><span>${(teamById(x.a)||{}).name||x.a}</span></div>
        <div class="br-score">${x.sa}–${x.sb}</div>
      </div>
      <div class="br-line ${x.winner==='b'?'winner':''}">
        <div class="br-team"><img src="${(teamById(x.b)||{}).logo||''}"><span>${(teamById(x.b)||{}).name||x.b}</span></div>
        <div class="br-score">${x.sb}–${x.sa}</div>
      </div>
    </div>`).join(''); };

  const mockQF=[{a:state.teams[0]?.id||'A', b:state.teams[1]?.id||'B', sa:2,sb:1, winner:'a'}];
  const mockSF=[{a:'VQ1', b:'—', sa:'-', sb:'-', winner:null}];
  const mockFI=[{a:'VD1', b:'VD2', sa:'-', sb:'-', winner:null}];

  make(mockQF,'qf'); make(mockSF,'sf'); make(mockFI,'fi');
  make(mockQF,'qf2'); make(mockSF,'sf2'); make(mockFI,'fi2');
}

function teamById(id){ return state.teams.find(t=>t.id===id) }

/* ========= Utils ========= */
function hexA(hex, a){
  const c = hex.replace('#',''); const n = parseInt(c,16);
  const r=(n>>16)&255,g=(n>>8)&255,b=n&255;
  return `rgba(${r},${g},${b},${a})`;
}

/* ========= Boot ========= */
initNav();
loadData().catch(err=>{
  const x = document.createElement('div'); x.className='panel'; x.textContent = 'Erreur: ' + err.message;
  document.body.appendChild(x);
});
</script>
</body>
</html>
