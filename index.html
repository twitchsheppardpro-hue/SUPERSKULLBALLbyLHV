<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Skullball – Tournoi</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg-dark: #0f1720;
  --bg-panel: #151b23;
  --text: #e8eef7;
  --muted: #95a2b3;
  --accent: #ff8a00;
  --pill-bg: rgba(255,255,255,.1);
  --pill-stroke: rgba(255,255,255,.25);
  --shadow: 0 6px 24px rgba(0,0,0,.35);
  --gold1: #d0a45e;
  --gold2: #b08648;
  --row-border: #263141;
}

* { box-sizing: border-box; }
html, body { height: 100%; }
body {
  margin: 0;
  font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
  color: var(--text);
  background: linear-gradient(135deg, #002654 0%, #002654 30%, #ffffff 50%, #CE1126 80%, #CE1126 100%);
  background-attachment: fixed;
}
.container { max-width: 1200px; margin: 0 auto; padding: 0 16px; }

header.app-head {
  position: sticky; top: 0; z-index: 50;
  padding: 18px 0;
  backdrop-filter: blur(8px);
  background: linear-gradient(90deg, rgba(0,38,84,0.92) 0%, rgba(0,38,84,0.6) 35%, rgba(255,255,255,0.12) 60%, rgba(206,17,38,0.55) 80%, rgba(206,17,38,0.7) 100%);
  border-bottom: 1px solid rgba(255,255,255,.1);
}
.head-row { display: grid; grid-template-columns: auto 1fr auto; gap: 20px; align-items: center; }
.logo-wrap { display:flex; align-items:center; gap:16px; }
.logo-wrap img.event-logo {
  width: 92px; height: 92px; border-radius: 14px; object-fit: cover;
  box-shadow: 0 10px 26px rgba(0,0,0,.35);
}
h1.title { margin: 0; font-weight: 800; font-size: 28px; letter-spacing: .2px; text-shadow: 0 2px 8px rgba(0,0,0,.35); }
.nav-pills { display:flex; gap: 14px; flex-wrap: wrap; }

.pill {
  display:inline-flex; align-items:center; gap:10px;
  padding: 10px 16px; border-radius: 999px;
  background: var(--pill-bg);
  border: 1px solid var(--pill-stroke);
  color: var(--text); font-weight: 600; cursor: pointer; user-select: none;
  transition: transform .04s ease, background .15s ease, border-color .15s ease;
}
.pill.active { background: #ff9c1a; border-color: transparent; color: #1b1103; }
.pill:hover { transform: translateY(-1px); }

.admin-pill { justify-self: end; }
.admin-pill svg { width: 16px; height: 16px; }

main { padding: 22px 0 64px; }
.panel {
  background: linear-gradient(180deg, rgba(12,18,26,0.86), rgba(12,18,26,0.86)) padding-box;
  border: 1px solid rgba(255,255,255,.08);
  border-radius: 16px; padding: 18px; box-shadow: var(--shadow);
}

.subnav { display:flex; gap:10px; align-items:center; margin: 8px 0 12px; }
.subnav .pill { background: rgba(255,255,255,.06); }

.caption { color: var(--muted); font-size: 14px; margin-bottom: 8px; }

/* Classement table */
.table { width: 100%; border-collapse: collapse; border-spacing: 0; }
.table thead th {
  font-weight: 700; text-align:left; padding: 12px 10px; font-size: 14px; color: #dbe6f6; border-bottom: 1px solid rgba(255,255,255,.08);
}
.table tbody td {
  padding: 14px 10px; border-bottom: 1px solid rgba(255,255,255,.06); font-size: 15px;
}
.table .pos { width: 36px; font-weight: 700; color: #fff; }
.team-cell { display:flex; align-items:center; gap:12px; }
.team-logo { width: 44px; height: 44px; border-radius: 12px; object-fit: cover; background: #0a0f16; border: 1px solid rgba(255,255,255,.1); }
.row-top { background: linear-gradient(0deg, rgba(0,0,0,.1), rgba(0,0,0,.1)), linear-gradient(90deg, var(--gold1), var(--gold2)); }
.row-regular { background: rgba(255,255,255,.02); }

/* Live match */
.live-wrap { display:grid; grid-template-columns: 1fr 160px 1fr; gap: 16px; align-items: center; }
.side { background: linear-gradient(180deg, rgba(20,26,35,.9), rgba(20,26,35,.9)); padding: 18px; border-radius: 14px; border: 1px solid rgba(255,255,255,.06); position: relative; }
.side .team-bar { display:flex; align-items:center; gap:12px; padding: 10px 12px; border-radius: 10px; background: rgba(255,255,255,.04); }
.side .team-name { font-weight: 800; font-size: 20px; }
.score-box { text-align:center; background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.08); border-radius: 14px; padding: 14px; }
.score-box .score { font-size: 48px; font-weight: 800; }
.time-badge { display:inline-block; margin-top: 8px; padding: 6px 12px; border-radius: 999px; background: var(--pill-bg); border: 1px solid var(--pill-stroke); font-weight: 700; }

.ctrls { display:flex; gap:10px; justify-content:center; margin-top: 10px; }
.ctrls button {
  padding: 8px 10px; border-radius: 10px; border: 1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.06); color: var(--text); cursor: pointer; font-weight: 700;
}
.small { font-size: 12px; color: var(--muted); }

.flex { display:flex; gap: 12px; align-items:center; }
.select, select, input[type="text"] {
  background: rgba(255,255,255,.06); color: var(--text); border: 1px solid rgba(255,255,255,.12);
  border-radius: 10px; padding: 10px 12px; font-weight: 600;
}
button.primary { background: #ff9c1a; color: #1b1103; border: none; }
button.linklike { background: transparent; border: none; color: var(--muted); cursor:pointer; text-decoration: underline; }

/* Finished matches list */
.match-card {
  display:grid; grid-template-columns: 1fr 80px 1fr; align-items:center; gap: 8px;
  background: rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px 12px;
}
.match-side { display:flex; align-items:center; gap:10px; font-weight:700; }
.match-side img { width: 28px; height: 28px; border-radius:8px; border:1px solid rgba(255,255,255,.12); }
.match-score { text-align:center; font-weight:800; font-size: 20px; }

/* Phase finale */
.bracket { display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
.bracket .bucket { background: rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:12px; }
.bucket h3 { margin: 0 0 8px; }
.bracket .pair { display:flex; align-items:center; justify-content:space-between; gap: 8px; background: rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:8px 10px; margin-bottom:8px; }
.bracket .pair .left, .bracket .pair .right { display:flex; align-items:center; gap:8px; }
.bracket .pair img { width: 24px; height: 24px; border-radius:6px; border:1px solid rgba(255,255,255,.12); }
.bracket .pair .score { font-weight:800; }

/* Footer spacer */
footer { height: 32px; }

.hidden { display:none !important; }
</style>
</head>
<body>
<header class="app-head">
  <div class="container head-row">
    <div class="logo-wrap">
      <img class="event-logo" id="eventLogo" alt="Logo évènement" src="" onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2292%22 height=%2292%22><rect width=%2292%22 height=%2292%22 rx=%2214%22 fill=%22%23101818%22/><text x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%22%23fff%22 font-size=%2212%22 font-family=%22Inter%22>Logo</text></svg>'">
      <h1 class="title" id="leagueTitle">Ligue Hexa – V8.20</h1>
    </div>
    <nav class="nav-pills" id="mainNav">
      <button class="pill" data-tab="classement">Classement</button>
      <button class="pill" data-tab="live">Matchs en direct</button>
      <button class="pill" data-tab="finished">Matchs terminés</button>
      <button class="pill" data-tab="bracket">Phase finale</button>
      <button class="pill" data-tab="manage">Gestion</button>
    </nav>
    <button id="adminToggle" class="pill admin-pill" title="Basculer mode admin">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 17a2 2 0 0 0 2-2V9a2 2 0 1 0-4 0v6a2 2 0 0 0 2 2z"/><path d="M7 9V7a5 5 0 1 1 10 0v2"/><rect x="5" y="9" width="14" height="10" rx="2"/>
      </svg>
      Admin
    </button>
  </div>
</header>

<main class="container">
  <!-- CLASSEMENT TAB -->
  <section id="tab-classement" class="panel hidden">
    <div class="caption">Tri : Points ▸ Diff ▸ BP ▸ Confrontation directe.</div>
    <div class="subnav">
      <button class="pill sub active" data-sub="tableau">Classement</button>
      <button class="pill sub" data-sub="buteurs">Buteurs</button>
    </div>

    <div id="classement-view">
      <table class="table" id="standingsTable">
        <thead>
          <tr>
            <th class="pos">#</th><th>Équipe</th>
            <th>J</th><th>G</th><th>N</th><th>P</th>
            <th>BP</th><th>BC</th><th>Diff</th>
            <th>BO</th><th>BD</th><th>Pts</th>
          </tr>
        </thead>
        <tbody id="standingsBody"></tbody>
      </table>
    </div>

    <div id="buteurs-view" class="hidden">
      <table class="table">
        <thead><tr><th class="pos">#</th><th>Joueur</th><th>Club</th><th>Buts</th></tr></thead>
        <tbody id="scorersBody"></tbody>
      </table>
    </div>
  </section>

  <!-- LIVE TAB -->
  <section id="tab-live" class="panel hidden">
    <div class="live-wrap">
      <div class="side" id="sideA">
        <div class="team-bar">
          <img id="teamALogo" class="team-logo" alt="logo A"/>
          <div class="team-name" id="teamAName">—</div>
        </div>
        <div class="admin-only" id="adminA">
          <div class="flex" style="margin-top:10px">
            <label class="small">Équipe A</label>
            <select id="teamASelect"></select>
          </div>
          <div class="flex">
            <label class="small">Buteur</label>
            <select id="teamAPlayer"></select>
            <button class="primary" id="addGoalA">+1</button>
            <button id="subGoalA">-1</button>
          </div>
          <div id="logA" class="small"></div>
        </div>
      </div>

      <div class="score-box">
        <div class="small" id="roundLabel">Journée 1</div>
        <div class="pill" style="display:inline-block;margin:6px 0;">EN DIRECT</div>
        <div class="score"><span id="scoreA">0</span> – <span id="scoreB">0</span></div>
        <div class="time-badge" id="timer">00:00</div>
        <div class="ctrls admin-only">
          <button id="playBtn">▶</button>
          <button id="pauseBtn">⏸</button>
          <button id="resetBtn">↺</button>
        </div>
        <div class="ctrls admin-only">
          <button class="primary" id="finishBtn">Match terminé</button>
          <button id="swapBtn">Inverser côtés</button>
        </div>
        <div class="small" id="matchId">ID —</div>
      </div>

      <div class="side" id="sideB">
        <div class="team-bar">
          <div class="team-name" id="teamBName">—</div>
          <img id="teamBLogo" class="team-logo" alt="logo B"/>
        </div>
        <div class="admin-only" id="adminB">
          <div class="flex" style="margin-top:10px">
            <label class="small">Équipe B</label>
            <select id="teamBSelect"></select>
          </div>
          <div class="flex">
            <label class="small">Buteur</label>
            <select id="teamBPlayer"></select>
            <button class="primary" id="addGoalB">+1</button>
            <button id="subGoalB">-1</button>
          </div>
          <div id="logB" class="small"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- FINISHED TAB -->
  <section id="tab-finished" class="panel hidden">
    <div id="finishedList" class="vstack" style="display:grid; gap:10px;"></div>
  </section>

  <!-- BRACKET TAB -->
  <section id="tab-bracket" class="panel hidden">
    <div class="bracket">
      <div class="bucket">
        <h3>Barrages</h3>
        <div id="barrages"></div>
      </div>
      <div class="bucket">
        <h3>Demi-finales</h3>
        <div id="demis"></div>
      </div>
      <div class="bucket">
        <h3>Finale</h3>
        <div id="finale"></div>
      </div>
    </div>
  </section>

  <!-- MANAGE TAB -->
  <section id="tab-manage" class="panel hidden">
    <h3>Gestion</h3>
    <p class="small">Mode simple : tout est en local (localStorage). Vous pouvez ré-initialiser ci-dessous.</p>
    <div class="flex">
      <button class="primary" id="resetData">Ré-initialiser les données (scores, matchs)</button>
      <button id="reloadTeams">Recharger les équipes</button>
    </div>
    <p class="small">Pour charger un teams.json depuis GitHub, éditez la constante <code>DATA_URL</code> en haut du script (ou mettez un fichier <code>teams.json</code> à côté).</p>
  </section>
</main>

<footer></footer>

<!-- Embedded fallback teams JSON (used if no fetch URL works) -->
<script id="teams-json" type="application/json">
{
  "leagueName": "National League of Skullball",
  "eventLogo": "logos/logoevent.png",
  "teams": [
    {
      "id": 1,
      "name": "Le Hollandais Violent",
      "logo": "logos/equipe1.png",
      "color": "#202532",
      "players": ["Sheppard", "Etagon", "Kz", "Lama", "Sqyze", "Skyllocks"]
    },
    {
      "id": 2,
      "name": "Aviron Bayonnais",
      "logo": "logos/equipe2.png",
      "color": "#202532",
      "players": ["Joueur 1", "Joueur 2", "Joueur 3", "Joueur 4", "Joueur 5", "Joueur 6"]
    },
    {
      "id": 3,
      "name": "Castres Olympique",
      "logo": "logos/equipe3.png",
      "color": "#202532",
      "players": ["Joueur 1", "Joueur 2", "Joueur 3", "Joueur 4", "Joueur 5", "Joueur 6"]
    },
    {
      "id": 4,
      "name": "Provence Rugby",
      "logo": "logos/equipe4.png",
      "color": "#202532",
      "players": ["Joueur 1", "Joueur 2", "Joueur 3", "Joueur 4", "Joueur 5", "Joueur 6"]
    },
    {
      "id": 5,
      "name": "RC Toulon",
      "logo": "logos/equipe5.png",
      "color": "#202532",
      "players": ["Joueur 1", "Joueur 2", "Joueur 3", "Joueur 4", "Joueur 5", "Joueur 6"]
    },
    {
      "id": 6,
      "name": "RC Vannes",
      "logo": "logos/equipe6.png",
      "color": "#202532",
      "players": ["Joueur 1", "Joueur 2", "Joueur 3", "Joueur 4", "Joueur 5", "Joueur 6"]
    },
    {
      "id": 7,
      "name": "Section Paloise",
      "logo": "logos/equipe7.png",
      "color": "#202532",
      "players": ["Joueur 1", "Joueur 2", "Joueur 3", "Joueur 4", "Joueur 5", "Joueur 6"]
    },
    {
      "id": 8,
      "name": "Stade Toulousain",
      "logo": "logos/equipe8.png",
      "color": "#202532",
      "players": ["Joueur 1", "Joueur 2", "Joueur 3", "Joueur 4", "Joueur 5", "Joueur 6"]
    },
    {
      "id": 9,
      "name": "Stade Rochelais",
      "logo": "logos/equipe9.png",
      "color": "#202532",
      "players": ["Joueur 1", "Joueur 2", "Joueur 3", "Joueur 4", "Joueur 5", "Joueur 6"]
    },
    {
      "id": 10,
      "name": "Perpignan",
      "logo": "logos/equipe10.png",
      "color": "#202532",
      "players": ["Joueur 1", "Joueur 2", "Joueur 3", "Joueur 4", "Joueur 5", "Joueur 6"]
    },
    {
      "id": 11,
      "name": "Nevers",
      "logo": "logos/equipe11.png",
      "color": "#202532",
      "players": ["Joueur 1", "Joueur 2", "Joueur 3", "Joueur 4", "Joueur 5", "Joueur 6"]
    },
    {
      "id": 12,
      "name": "US Montauban",
      "logo": "logos/equipe12.png",
      "color": "#202532",
      "players": ["Joueur 1", "Joueur 2", "Joueur 3", "Joueur 4", "Joueur 5", "Joueur 6"]
    },
    {
      "id": 13,
      "name": "Union Bordeaux Bègles",
      "logo": "logos/equipe13.png",
      "color": "#202532",
      "players": ["Joueur 1", "Joueur 2", "Joueur 3", "Joueur 4", "Joueur 5", "Joueur 6"]
    },
    {
      "id": 14,
      "name": "Lyon OU",
      "logo": "logos/equipe14.png",
      "color": "#202532",
      "players": ["Joueur 1", "Joueur 2", "Joueur 3", "Joueur 4", "Joueur 5", "Joueur 6"]
    }
  ]
}


</script>

<script>
// =================== Config ===================
// Option 1: leave empty to use embedded JSON OR local 'teams.json'
// Option 2: set to raw GitHub URL (ex: 'https://raw.githubusercontent.com/user/repo/branch/teams.json')
const DATA_URL = "";

// =================== State ===================
let TEAMS = [];
let FINISHED_MATCHES = JSON.parse(localStorage.getItem('skullball_finished')||'[]');
let STATS = {}; // teamId -> stats
let ADMIN_MODE = false;
let current = { teamA: null, teamB: null, scoreA:0, scoreB:0, events:[], startTs:null, running:false, id: genId() };

// =================== Utilities ===================
function el(id){ return document.getElementById(id); }
function q(sel, ctx=document){ return ctx.querySelector(sel); }
function qa(sel, ctx=document){ return Array.from(ctx.querySelectorAll(sel)); }
function genId(){ return Math.random().toString(36).slice(2,8); }
function formatTime(sec){
  const m = Math.floor(sec/60).toString().padStart(2,'0');
  const s = Math.floor(sec%60).toString().padStart(2,'0');
  return m+':'+s;
}

// =================== Load teams ===================
async function loadTeams(){
  try{
    let data;
    if (DATA_URL){
      const r = await fetch(DATA_URL, {cache:'no-store'});
      data = await r.json();
    } else {
      // try local teams.json first (works when served via http)
      try {
        const r2 = await fetch('teams.json', {cache:'no-store'});
        if (r2.ok) data = await r2.json();
      } catch(e){/* ignore */}
      if (!data){
        // fallback to embedded
        data = JSON.parse(el('teams-json').textContent);
      }
    }
    TEAMS = data.teams || [];
    // UI: header
    el('leagueTitle').textContent = data.leagueName || 'Ligue Hexa – V8.20';
    if (data.eventLogo) el('eventLogo').src = data.eventLogo;
    // populate selects
    const opts = TEAMS.map(t=>`<option value="${t.id}">${t.name}</option>`).join('');
    el('teamASelect').innerHTML = '<option value="">—</option>'+opts;
    el('teamBSelect').innerHTML = '<option value="">—</option>'+opts;
    // init stats
    STATS = {};
    TEAMS.forEach(t=>{
      STATS[t.id] = {J:0,G:0,N:0,P:0,BP:0,BC:0,Diff:0,BO:0,BD:0,Pts:0};
    });
    // default teams for live panel
    if (!current.teamA && TEAMS.length>=2){
      setTeam('A', TEAMS[0].id);
      setTeam('B', TEAMS[1].id);
    }
    renderStandings();
    renderBracket();
    renderFinished();
  }catch(e){
    console.error('loadTeams failed', e);
  }
}

// =================== Tabs ===================
function activateTab(key){
  qa('#mainNav .pill').forEach(p=>p.classList.toggle('active', p.dataset.tab===key));
  qa('main > section').forEach(sec=>sec.classList.toggle('hidden', !sec.id.endsWith(key)));
  localStorage.setItem('skullball_tab', key);
  if(key==='classement'){ activateSub(localStorage.getItem('skullball_sub')||'tableau'); }
}
function activateSub(k){
  qa('.subnav .pill').forEach(p=>p.classList.toggle('active', p.dataset.sub===k));
  el('classement-view').classList.toggle('hidden', k!=='tableau');
  el('buteurs-view').classList.toggle('hidden', k!=='buteurs');
  localStorage.setItem('skullball_sub', k);
}

document.addEventListener('click', (e)=>{
  const t = e.target.closest('.pill');
  if(t && t.dataset.tab){ activateTab(t.dataset.tab); }
  const s = e.target.closest('.pill.sub');
  if(s && s.dataset.sub){ activateSub(s.dataset.sub); }
});

// =================== Admin toggle ===================
el('adminToggle').addEventListener('click', ()=>{
  ADMIN_MODE = !ADMIN_MODE;
  qa('.admin-only').forEach(n=>n.classList.toggle('hidden', !ADMIN_MODE));
  el('adminToggle').classList.toggle('active', ADMIN_MODE);
});
qa('.admin-only').forEach(n=>n.classList.add('hidden'));

// =================== Live match logic ===================
let timerInt = null;
function startTimer(){
  if(current.running) return;
  current.running = true;
  current.startTs = Date.now() - (current.elapsed || 0);
  timerInt = setInterval(()=>{
    current.elapsed = Date.now()-current.startTs;
    el('timer').textContent = formatTime(current.elapsed/1000);
  }, 250);
}
function pauseTimer(){ if(timerInt){ clearInterval(timerInt); timerInt=null; } current.running=false; }
function resetTimer(){ pauseTimer(); current.elapsed = 0; el('timer').textContent='00:00'; }

el('playBtn').addEventListener('click', startTimer);
el('pauseBtn').addEventListener('click', pauseTimer);
el('resetBtn').addEventListener('click', resetTimer);

function teamById(id){ return TEAMS.find(t=>t.id==id); }
function setTeam(side, id){
  if(!id){ return; }
  id = Number(id);
  if(side==='A'){
    current.teamA=id;
    el('teamAName').textContent = teamById(id)?.name || '—';
    el('teamALogo').src = teamById(id)?.logo || '';
    // players
    const ps = (teamById(id)?.players||[]).map(p=>`<option value="{p}">{p}</option>`.replaceAll('{p}', p)).join('');
    el('teamAPlayer').innerHTML = ps;
  } else {
    current.teamB=id;
    el('teamBName').textContent = teamById(id)?.name || '—';
    el('teamBLogo').src = teamById(id)?.logo || '';
    const ps = (teamById(id)?.players||[]).map(p=>`<option value="{p}">{p}</option>`.replaceAll('{p}', p)).join('');
    el('teamBPlayer').innerHTML = ps;
  }
}
el('teamASelect').addEventListener('change', e=> setTeam('A', e.target.value));
el('teamBSelect').addEventListener('change', e=> setTeam('B', e.target.value));

function addGoal(side){
  const stamp = formatTime((current.elapsed||0)/1000);
  if(side==='A'){ current.scoreA++; el('scoreA').textContent=current.scoreA; const pl = el('teamAPlayer').value||'?'; current.events.push({side:'A', player:pl, t:stamp}); el('logA').textContent += ` + ${pl} (${stamp})`; }
  if(side==='B'){ current.scoreB++; el('scoreB').textContent=current.scoreB; const pl = el('teamBPlayer').value||'??'; current.events.push({side:'B', player:pl, t:stamp}); el('logB').textContent += ` + ${pl} (${stamp})`; }
}
function subGoal(side){
  if(side==='A' && current.scoreA>0){ current.scoreA--; el('scoreA').textContent=current.scoreA; }
  if(side==='B' && current.scoreB>0){ current.scoreB--; el('scoreB').textContent=current.scoreB; }
}
el('addGoalA').addEventListener('click', ()=>addGoal('A'));
el('addGoalB').addEventListener('click', ()=>addGoal('B'));
el('subGoalA').addEventListener('click', ()=>subGoal('A'));
el('subGoalB').addEventListener('click', ()=>subGoal('B'));
el('swapBtn').addEventListener('click', ()=>{
  const ta=current.teamA, tb=current.teamB;
  setTeam('A', tb); setTeam('B', ta);
});

function finishMatch(){
  pauseTimer();
  if(!(current.teamA && current.teamB)) return alert('Sélectionne les deux équipes.');
  const match = {
    id: current.id, a: current.teamA, b: current.teamB,
    ga: current.scoreA, gb: current.scoreB,
    elapsed: Math.floor((current.elapsed||0)/1000),
    events: current.events, ts: Date.now()
  };
  FINISHED_MATCHES.push(match);
  localStorage.setItem('skullball_finished', JSON.stringify(FINISHED_MATCHES));
  // update stats (simple football rules: 3/1/0; BO/BD non gérés ici)
  const A = STATS[match.a], B = STATS[match.b];
  A.J++; B.J++;
  A.BP += match.ga; A.BC += match.gb; A.Diff = A.BP - A.BC;
  B.BP += match.gb; B.BC += match.ga; B.Diff = B.BP - B.BC;
  if(match.ga>match.gb){ A.G++; B.P++; A.Pts+=3; }
  else if(match.gb>match.ga){ B.G++; A.P++; B.Pts+=3; }
  else { A.N++; B.N++; A.Pts++; B.Pts++; }
  renderStandings();
  renderFinished();
  // reset current
  current = { teamA: current.teamA, teamB: current.teamB, scoreA:0, scoreB:0, events:[], startTs:null, running:false, id: genId() };
  el('scoreA').textContent='0'; el('scoreB').textContent='0'; el('logA').textContent=''; el('logB').textContent=''; resetTimer();
  el('matchId').textContent = 'ID ' + current.id;
  alert('Match archivé.');
}
el('finishBtn').addEventListener('click', finishMatch);
el('matchId').textContent = 'ID ' + current.id;

// =================== Standings ===================
function renderStandings(){
  const rows = Object.entries(STATS).map(([id,s])=>({ id:Number(id), ...s, name: teamById(id)?.name||'?', logo: teamById(id)?.logo||'' }));
  rows.sort((a,b)=> b.Pts - a.Pts || b.Diff - a.Diff || b.BP - a.BP || a.name.localeCompare(b.name));
  const body = el('standingsBody'); body.innerHTML = '';
  rows.forEach((r,idx)=>{
    const tr = document.createElement('tr');
    tr.className = idx<6 ? 'row-top' : 'row-regular';
    tr.innerHTML = `
      <td class="pos">{pos}</td>
      <td><div class="team-cell"><img class="team-logo" src="{logo}" onerror="this.style.opacity=.25" alt=""><div>{name}</div></div></td>
      <td>{J}</td><td>{G}</td><td>{N}</td><td>{P}</td>
      <td>{BP}</td><td>{BC}</td><td>{Diff}</td><td>{BO}</td><td>{BD}</td><td><strong>{Pts}</strong></td>
    `.replaceAll('{pos}', idx+1)
     .replaceAll('{logo}', r.logo).replaceAll('{name}', r.name)
     .replaceAll('{J}', r.J).replaceAll('{G}', r.G).replaceAll('{N}', r.N).replaceAll('{P}', r.P)
     .replaceAll('{BP}', r.BP).replaceAll('{BC}', r.BC).replaceAll('{Diff}', r.Diff)
     .replaceAll('{BO}', r.BO).replaceAll('{BD}', r.BD).replaceAll('{Pts}', r.Pts);
    body.appendChild(tr);
  });

  // scorers from events in finished matches
  const counts = new Map();
  FINISHED_MATCHES.forEach(m=>{
    m.events.forEach(ev=>{
      const tid = ev.side==='A' ? m.a : m.b;
      const tname = teamById(tid)?.name || '?';
      const key = ev.player + '||' + tname;
      counts.set(key, (counts.get(key)||0)+1);
    });
  });
  const arr = Array.from(counts.entries()).map(([k,v])=>{
    const [player,club] = k.split('||');
    return {player, club, goals:v};
  }).sort((a,b)=> b.goals-a.goals || a.player.localeCompare(b.player));
  const sb = el('scorersBody'); sb.innerHTML='';
  arr.forEach((it,idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="pos">{i}</td><td>{p}</td><td>{c}</td><td><strong>{g}</strong></td>`
      .replace('{i}', idx+1).replace('{p}', it.player).replace('{c}', it.club).replace('{g}', it.goals);
    sb.appendChild(tr);
  });
}

// =================== Finished list ===================
function renderFinished(){
  const box = el('finishedList'); box.innerHTML = '';
  FINISHED_MATCHES.slice().reverse().forEach(m=>{
    const a = teamById(m.a) || {name:'?', logo:''}, b = teamById(m.b) || {name:'?', logo:''};
    const card = document.createElement('div');
    card.className='match-card';
    card.innerHTML = `
      <div class="match-side"><img src="{alogo}" alt=""><span>{aname}</span></div>
      <div class="match-score">{ga} – {gb}</div>
      <div class="match-side" style="justify-content: flex-end;"><span>{bname}</span><img src="{blogo}" alt=""></div>
    `.replace('{alogo}', a.logo).replace('{aname}', a.name)
     .replace('{ga}', m.ga).replace('{gb}', m.gb)
     .replace('{bname}', b.name).replace('{blogo}', b.logo);
    box.appendChild(card);
  });
}

// =================== Bracket (placeholder pairs from top standings) ===================
function renderBracket(){
  const rows = Object.entries(STATS).map(([id,s])=>({ id:Number(id), ...s, name: teamById(id)?.name||'?', logo: teamById(id)?.logo||'' }));
  rows.sort((a,b)=> b.Pts - a.Pts || b.Diff - a.Diff || b.BP - a.BP || a.name.localeCompare(b.name));
  const top8 = rows.slice(0,8);
  const mk = (l, r)=> `<div class="pair"><div class="left"><img src="{ll}"><span>{ln}</span></div><div class="score">0</div><div class="right"><span>{rn}</span><img src="{rl}"></div></div>`
      .replace('{ll}', l.logo).replace('{ln}', l.name).replace('{rn}', r.name).replace('{rl}', r.logo);
  document.getElementById('barrages').innerHTML = top8.length>=8 ?
    mk(top8[0], top8[7]) + mk(top8[3], top8[4]) : '<div class="small">Définir les équipes…</div>';
  document.getElementById('demis').innerHTML = top8.length>=8 ?
    mk(top8[1], top8[6]) + mk(top8[2], top8[5]) : '<div class="small">Définir les équipes…</div>';
  const f1 = rows[0] || {logo:'',name:'—'};
  const f2 = rows[1] || {logo:'',name:'—'};
  document.getElementById('finale').innerHTML = mk(f1, f2);
}

// =================== Manage ===================
document.getElementById('resetData').addEventListener('click', ()=>{
  if(!confirm('Tout ré-initialiser (scores et matchs) ?')) return;
  FINISHED_MATCHES = [];
  localStorage.removeItem('skullball_finished');
  // reset stats
  Object.keys(STATS).forEach(id=> STATS[id] = {J:0,G:0,N:0,P:0,BP:0,BC:0,Diff:0,BO:0,BD:0,Pts:0} );
  renderStandings(); renderFinished(); renderBracket();
});
document.getElementById('reloadTeams').addEventListener('click', loadTeams);

// =================== Boot ===================
document.querySelectorAll('#mainNav .pill').forEach(p=> p.addEventListener('click', ()=> activateTab(p.dataset.tab)));
function boot(){
  const savedTab = localStorage.getItem('skullball_tab') || 'classement';
  activateTab(savedTab);
  activateSub(localStorage.getItem('skullball_sub')||'tableau');
  loadTeams();
}
boot();
</script>
</body>
</html>
